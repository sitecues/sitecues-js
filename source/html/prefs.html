<!DOCTYPE html>
<html>
<head>
  <title>Sitecues Data</title>
</head>
<body>
<script type="text/javascript">
  (function() {
    function logError(event, error) {
      console.log(error);
      event.source.postMessage({
        error: error
      }, event.origin);
    }

    function getParsedGlobalData() {
      var rawData = localStorage.getItem('sitecues');
      return rawData && JSON.parse(rawData);
    }

    // Save: Should be called any time the Sitecues preferences or user id change
    function saveData(event) {
      var globalData = {},
        globalUserId,
        providedData = event.data.prefs,
        providedUserId = providedData.userId;
      try {
        globalData = getParsedGlobalData();
      }
      catch(ex) {
        console.log('Invalid Sitecues storage backup data');
      }
      globalUserId = globalData && globalData.userId;
      if (!providedUserId|| typeof providedUserId !== 'string') {
        logError(event, 'Invalid user id save attempt');
        return;
      }
      if (typeof globalUserId === 'string' && providedUserId > globalUserId) {
        // In case of user id mismatch will reject if the new user id is larger
        // This way the system will gradually settle on the smallest user id used in any page
        logError(event, 'User id mismatch in Sitecues storage backup.');
        return;
      }
      try {
        localStorage.setItem('sitecues', JSON.stringify(providedData));
      }
      catch (ex) {
        // Sometimes third party site data is disallowed in browser security settings. New user will be created.
        logError(event, 'Cannot save preferences.\n' + ex);
        return;
      }

      event.source.postMessage({}, event.origin);
    }

    // Load: Should only be called once, at the launch of Sitecues
    function loadData(event) {
      var data;
      try {
        data = getParsedGlobalData();
      }
      catch (ex) {
        // Sometimes third party site data is disallowed in browser security settings. Sitecues will not sync its settings between different websites.
        logError(event, 'Cannot load preferences.\n' + ex);
        return;
      }

      function sendRawAppData(rawAppData) {
        event.source.postMessage({ name: 'sc-storage-reply', rawAppData: rawAppData }, event.origin);
      }

      if (!data) {
        sendRawAppData({});  // Never initialized -- this is a valid state
      }
      else if (typeof data.userId !== 'string') {
        logError(event, 'Backed up preferences contain invalid user id. Will repair.')
      }
      else {
        sendRawAppData(data);
      }
    }

    // If event.data.prefs is defined, we are saving the data
    // Else event.data.prefs is falsey, and we are retrieving the data
    function handleRequest(event) {
      if (event.data.name !== 'sc-storage-command') {
        return;  // This event is not for us
      }
      if (event.data.prefs) {   // Parsed data received
        saveData(event);
      }
      else {
        loadData(event);  // Will return parsed data
      }
    }

    window.addEventListener('message', handleRequest);
  })();
</script>
</body>
</html>