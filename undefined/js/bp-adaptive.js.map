{"version":3,"sources":["../../config-wrap-start-default.js","bp-adaptive/bp-adaptive.js","../../../../../../module-create.js"],"names":["sitecues","define","state","bpView","BP_CONST","nativeGlobal","lastBgColor","getBadgeElem","document","getElementById","BADGE_ID","checkBackgroundColorChange","onPaletteUpdate","doForceBadgeUpdate","newBgColor","getBackgroundColor","doBadgeUpdate","require","colorUtil","SC_DEV","console","log","badgeElem","set","isOnDarkBackground","PALETTE_NAME_REVERSE_BLUE","getDefaultPalette","get","getComputedStyle","body","backgroundColor","adaptToSitecuesThemeChange","newTheme","update","onPossibleWebpageThemeChange","setTimeout","initAdaptivePalette","addEventListener"],"mappings":"AAAA;;;;;;;;;;;;ACUAA,SAAAC,OACA,6BACA,sBACA,oBACA,oBACA,6BAEA,SACAC,OACAC,QACAC,UACAC;EAIA,IAAAC;EAEA,SAAAC;IACA,OAAAC,SAAAC,eAAAL,SAAAM;;EAGA,SAAAC,2BAAAC,iBAAAC;IACA,IAAAC,aAAAC,sBACAC,gBAAAH;IAEA,IAAAC,eAAAR,aAAA;MACAA,cAAAQ;MACAE,gBAAA;;IAGA,IAAAA;MACAhB,SAAAiB,UAAA,qBAAA,SAAAC;QACA,IAAAC;UAAAC,QAAAC,IAAA;;QACA,IAAAC,YAAAf;;;;QAIAL,MAAAqB,IAAA,cAAAL,UAAAM,mBAAAF,aAAAlB,SAAAqB,4BAAAC;QACA,IAAAd;UACAA;;;;;EAMA,SAAAc;IACA,OAAAxB,MAAAyB,IAAA;;EAGA,SAAAZ;IACA,OAAAa,iBAAApB,SAAAqB,MAAAC;;EAGA,SAAAC,2BAAAC;IACA,IAAA9B,MAAAyB,IAAA;MACA;;;IAGAzB,MAAAqB,IAAA,qBAAA,WAAAS;IACArB,2BAAAR,OAAA8B,QAAA;;;;EAKA,SAAAC;IACA7B,aAAA8B,WAAA;MACAxB,2BAAAR,OAAA8B;OACA;;;;EAKA,SAAAG,oBAAAxB;IACAV,MAAAqB,IAAA,qBAAA;IAEAf,SAAAqB,KAAAQ,iBAAA,SAAAH;IACA1B,SAAAqB,KAAAQ,iBAAA,SAAAH;IACAvB,2BAAAC,iBAAA;;EAGA;IACAwB,qBAAAA;IACAL,4BAAAA;;;;AC3FA/B,SAAAC,OAAA,eAAA","file":"bp-adaptive.js.map","sourcesContent":["\"use strict\";\n","/**\n * Handle theme changes either from website itself or from sitecues,\n * and automatically adjust the badge palette colors if the background changes (e.g. from white to black)\n *\n * For theme changes implemented by the web page itself:\n * - Listen for user input and check the page background to see if it changed via onWebPageThemeChange()\n *\n * For theme changes implemented by sitecues:\n * - Get notification of theme change via onSitecuesThemeChange()\n */\nsitecues.define(\n  'bp-adaptive/bp-adaptive',[\n    'run/bp/model/state',\n    'run/bp/view/view',\n    'run/bp/constants',\n    'mini-core/native-global'\n  ],\n  function (\n    state,\n    bpView,\n    BP_CONST,\n    nativeGlobal\n  ) {\n  'use strict';\n\n  var lastBgColor;\n\n  function getBadgeElem() {\n    return document.getElementById(BP_CONST.BADGE_ID);\n  }\n\n  function checkBackgroundColorChange(onPaletteUpdate, doForceBadgeUpdate) {\n    var newBgColor = getBackgroundColor(),\n      doBadgeUpdate = doForceBadgeUpdate;\n\n    if (newBgColor !== lastBgColor) {\n      lastBgColor = newBgColor;\n      doBadgeUpdate = true;\n    }\n\n    if (doBadgeUpdate) {\n      require(['page/util/color'], function(colorUtil) {\n        if (SC_DEV) { console.log('Updating badge palette'); }\n        var badgeElem = getBadgeElem();\n        // TODO a very strange exception occurs here sometimes, where colorUtil is undefined. Here are 2 reports:\n        //{\"eventId\":\"2d937402-fb54-492f-b381-1d8ba4a07482\",\"serverTs\":1464011020272,\"clientIp\":\"10.238.183.184\",\"siteKey\":\"s-9afa6ab9\",\"isTest\":false,\"userId\":null,\"clientData\":{\"scVersion\":\"4.0.73-RELEASE\",\"metricVersion\":12,\"sessionId\":\"b23bbe86-920d-46f9-8aa6-49f0342b31bc\",\"pageViewId\":\"2b8f1cd3-277a-4afe-abff-1853394c2265\",\"siteId\":\"s-9afa6ab9\",\"userId\":\"b4189839-09d8-4f59-b0dd-3225a4e10109\",\"pageUrl\":\"http://www.perkins.org/solutions/featured-products/bus-stop-challenge\",\"browserUserAgent\":\"Mozilla/5.0 (Windows NT 6.1; rv:45.0) Gecko/20100101 Firefox/45.0\",\"isClassicMode\":false,\"clientLanguage\":\"en-US\",\"source\":\"page\",\"isTester\":false,\"name\":\"error\",\"clientTimeMs\":1464011020087,\"zoomLevel\":1,\"ttsState\":false,\"details\":{\"message\":\"a is undefined\",\"stack\":\"a/<@http://js.sitecues.com/l/s;id=s-9afa6ab9/4.0.73-RELEASE/js/bp-adaptive.js:1:351\\nW@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:8:258\\nO@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:9:31\\nP/<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:10:28\\nk@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:20:462\\nO/k.then/</<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:21:72\\nc/</<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:19:226\\nc/<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:19:204\\na@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:19:94\\nwindow.setTimeout/<@http://www.perkins.org/solutions/featured-products/bus-stop-challenge:1:254\\n\"}}}\n        //{\"eventId\":\"c7f48c85-bc29-442d-b44a-28a2ef2157b2\",\"serverTs\":1464103968666,\"clientIp\":\"10.235.39.83\",\"siteKey\":\"s-9afa6ab9\",\"isTest\":false,\"userId\":null,\"clientData\":{\"scVersion\":\"4.0.73-RELEASE\",\"metricVersion\":12,\"sessionId\":\"4f5a5f25-c89f-43fe-a89e-a7696d4cf946\",\"pageViewId\":\"e502e7d3-30e6-49e5-838b-0ef2020f805d\",\"siteId\":\"s-9afa6ab9\",\"userId\":\"3dc4aedf-3df5-4f4b-8646-debe01da031c\",\"pageUrl\":\"http://www.perkins.org/solutions/featured-products/bus-stop-challenge\",\"browserUserAgent\":\"Mozilla/5.0 (Windows NT 6.1; rv:45.0) Gecko/20100101 Firefox/45.0\",\"isClassicMode\":false,\"clientLanguage\":\"en-US\",\"source\":\"page\",\"isTester\":false,\"name\":\"error\",\"clientTimeMs\":1464103967710,\"zoomLevel\":1,\"ttsState\":false,\"details\":{\"message\":\"c is undefined\",\"stack\":\".init/</<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:119:24\\nW@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:8:258\\nO@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:9:31\\nP/<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:10:28\\nk@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:20:462\\nO/k.then/</<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:21:72\\nc/</<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:19:226\\nc/<@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:19:204\\na@http://js.sitecues.com/l/s;id=s-9afa6ab9/js/sitecues.js:19:94\\nwindow.setTimeout/<@http://www.perkins.org/solutions/featured-products/bus-stop-challenge:1:254\\n\"}}}\n        state.set('paletteKey', colorUtil.isOnDarkBackground(badgeElem) ? BP_CONST.PALETTE_NAME_REVERSE_BLUE : getDefaultPalette());\n        if (onPaletteUpdate) {\n          onPaletteUpdate();\n        }\n      });\n    }\n  }\n\n  function getDefaultPalette() {\n    return state.get('defaultPaletteKey');\n  }\n\n  function getBackgroundColor() {\n    return getComputedStyle(document.body).backgroundColor;\n  }\n\n  function adaptToSitecuesThemeChange(newTheme) {\n    if (state.get('isToolbarBadge')) {\n        return; // Toolbars don't adapt to theme changes\n    }\n    // If sitecues theme changes to dark, force adaptive palette. Otherwise use default palette.\n    state.set('isAdaptivePalette', newTheme === 'dark');\n    checkBackgroundColorChange(bpView.update, true);\n  }\n\n  // Input event has occurred that may trigger a theme change produced from the website code\n  // (as opposed to sitecues-based themes). For example, harpo.com, cnib.ca, lloydsbank have their own themes.\n  function onPossibleWebpageThemeChange() {\n    nativeGlobal.setTimeout(function () {\n      checkBackgroundColorChange(bpView.update);\n    }, 0);\n  }\n\n  // Listen for change in the web page's custom theme (as opposed to the sitecues-based themes).\n  // We don't know when they occur so we check shortly after a click or keypress.\n  function initAdaptivePalette(onPaletteUpdate) {\n    state.set('isAdaptivePalette', true);\n\n    document.body.addEventListener('click', onPossibleWebpageThemeChange);\n    document.body.addEventListener('keyup', onPossibleWebpageThemeChange);\n    checkBackgroundColorChange(onPaletteUpdate, true);\n  }\n\n  return {\n    initAdaptivePalette: initAdaptivePalette,\n    adaptToSitecuesThemeChange: adaptToSitecuesThemeChange\n  };\n});\n\n","\nsitecues.define(\"bp-adaptive\", function(){});\n"]}